name: Call Leaderboard API

on:
  pull_request:
    types: [closed]
  pull_request_review:
    types: [submitted]

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
      - name: Debug secrets
        run: |
          echo "API URL is set: ${{ secrets.LEADERBOARD_API_URL != '' }}"
          echo "API KEY is set: ${{ secrets.LEADERBOARD_API_KEY != '' }}"
          echo "URL length: ${#API_URL}"
          echo "KEY length: ${#API_KEY}"
        env:
          API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          API_KEY: ${{ secrets.LEADERBOARD_API_KEY }}

      - name: Handle PR merged
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
        env:
          API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          API_KEY: ${{ secrets.LEADERBOARD_API_KEY }}
        run: |
          curl -sS -X POST "${API_URL}/events/pr-merged" \
            -H "Authorization: Bearer ${API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "repo": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "author": "${{ github.event.pull_request.user.login }}",
              "additions": ${{ github.event.pull_request.additions }},
              "deletions": ${{ github.event.pull_request.deletions }},
              "merged_at": "${{ github.event.pull_request.merged_at }}"
            }'

      - name: Handle review submitted
        if: ${{ github.event_name == 'pull_request_review' }}
        env:
          API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          API_KEY: ${{ secrets.LEADERBOARD_API_KEY }}
        run: |
          curl -sS -X POST "${API_URL}/events/review-submitted" \
            -H "Authorization: Bearer ${API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "repo": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "reviewer": "${{ github.event.review.user.login }}",
              "review_state": "${{ github.event.review.state }}",
              "submitted_at": "${{ github.event.review.submitted_at }}"
            }'
